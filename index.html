<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SVG Symbol Ref Generator with Preview</title>
    <link rel="stylesheet" type="text/css" href="./styles/icons.css">
    <link rel="stylesheet" type="text/css" href="./styles/base.css">
    <link rel="stylesheet" type="text/css" href="./styles/new-svg.css">
    <link rel="stylesheet" type="text/css" href="dist/icons-style.css">

    <script src="dist/icons-array.js"></script>
    <script src="dist/ux-icons-holder.js"></script>
    <script src="pages/svg-code-generator.js"></script>
</head>

<body>
    <div id="svg-container"></div>
    <div id="svg-code-generator" class="dN"></div>
    <div id="icons-list-parent" class="icons-list-parent-wrapper flex">

        <div class="helpdoc-propeties-sec flexcolumn p20 pT15">
            <div class="m0 icon-title mB10">Icons</div>
            <div class="flexcolumnchild">
                <ul id="iconsCategory" class="helpdoc-icon-list flexDirColumn">
                    <!-- <% iconsCategory.forEach(function(icon) {%>
                    <li class="left-sec-btn-categ {{if(selectedCategory === icon.api_name, 'categ-active')}}"
                        onclick="{{action ('changeIconCategory', icon)}}">
                        <span class="helpdoc-icon-name">{{icon.name}}</span>
                    </li>
                    <% }) %> -->
                </ul>
            </div>
        </div>
        <div class="icon-list-wrapper p20 pT15">
            <div id="add-new-icon">Add new icon</div>
            <div class="helpdoc-icon-category">
                <!-- <% iconsCategory.forEach(function(icon) {%> 
                <div class="mB50">
                    <div id="{{icon.api_name}}" class="helpdoc-icon-name pB12 headM">{{icon.name}}</div>
                    <div class="flex">
                        <% icon.icons.forEach(function(list) {%>. -->
                <div
                    class="helpdoc-icon-item cP {{if(selectedIcon && selectedIcon.iconName === list.iconName, 'active')}}">
                    <svg class="svg-icons {{iconClass}}">
                        <use href="#ZB_Empty_Feeds"></use>
                    </svg>


                </div>
                <div
                    class="helpdoc-icon-item cP {{if(selectedIcon && selectedIcon.iconName === list.iconName, 'active')}}">
                    <svg class="svg-icons {{iconClass}}">
                        <use href="#ZB_Empty_Records"></use>
                    </svg>
                </div>
                <!-- <ux-icons icon-name="{{list.iconName}}"
                                icon-class="{{if(list.iconClass, list.iconClass, 'zb30')}}"></ux-icons> -->
                <!--<% }) %>
                    </div>
                </div>
                 <% }) %> -->
            </div>
        </div>
        <div class="icon-detail-wrapper  p20 pT15 flexDirColumn" lyte-if="{{selectedIcon}}">
            <ux-icons icon-name="ZB_Close" icon-class="zb10 pA r20 cP t20"
                onclick="{{action('closeIconPreview')}}"></ux-icons>
            <div class="pB40 headM">Data</div>
            <div class="helpdoc-icon-item preview mB40">
                <ux-icons icon-name="{{selectedIcon.iconName}}"
                    icon-class="{{if(selectedIcon.iconClass, selectedIcon.iconClass, 'zb60')}}"></ux-icons>
            </div>
            <div class="helpdoc-icon-name mB40">
                <span class="headS pB20 mR5">Icon Name:</span>
                {{selectedIcon.iconName}}
            </div>
            <pre class="code-snippet">
            <div class="flex-center-v mB8">  
                <span class="taskbar"> 
                    <span class="barOne bar"></span>
                    <span class="barTwo bar"></span>
                    <span class="barThree bar"></span>
                </span> 
                <span class="mLauto mR5 icon-hover-dark-parent cP" lt-prop-title="Copy" onclick="{{action('copySampleDataCode')}}">  
                    <ux-icons icon-name="ZB_Copy" icon-class="zb16 hd-copy-codesnip-icon icon-hover-dark"></ux-icons>
                    <!-- <i class="bigin-sprite icon-copy-sm icon-copy-sm-mask hd-copy-codesnip-icon icon-hover-dark"></i> -->
                </span>
            </div>
            <code id="dataSecCodeSnippet">
                <span class="token punctuation">&lt;</span>
                <span class="token tag">ux-icons</span> 
                <span class="token attrname">icon-name =</span>
                <span class="token punctuation">"</span>
                <span class="token attrvalue">{{selectedIcon.iconName}}</span>
                <span class="token punctuation">"</span>
                <span class="token punctuation">&lt;/</span>
                <span class="token tag">ux-icons</span>
                <span class="token punctuation">&gt;</span>
            </code>
        </pre>
        </div>
        <button onclick="uploadFileToGitHub()">Push Changes to Private Repo</button>
    </div>


    <script>
        const addNewIconBtn = document.getElementById('add-new-icon');
        const svgContainer = document.getElementById('svg-container');
        const svgCodeContainer = document.getElementById('svg-code-generator');
        const iconsListParent = document.getElementById('icons-list-parent');
        svgContainer.innerHTML = uxIconsHTML;


        addNewIconBtn.addEventListener('click', function () {
            iconsListParent.classList.toggle('dN');
            svgCodeContainer.classList.toggle('dN');
            svgCodeContainer.innerHTML = svgGeneratorContent;
            if (!svgCodeContainer.classList.contains('dN')) {
                initiateSVGCodeGenerator();
            }
        });


        // function jsToJsonCompatible(jsStr) {
        //     return jsStr
        //         .replace(/([{,])\s*(\w+)\s*:/g, '$1 "$2":')     // Quote keys
        //         .replace(/'/g, '"')                             // Convert single quotes to double
        //         .replace(/,\s*([}\]])/g, '$1')                  // Remove trailing commas
        //         .replace(/\/\/.*$/gm, '');                      // Remove comments
        // }

        async function uploadFileToGitHub(updatedIconSVG, commitMessage = 'üí° Updated icons in a single commit') {
            const token = prompt("üîí Paste your GitHub token (not saved anywhere):");
            if (!token || token.includes('ghp_') === false) {
                alert("‚ùå Invalid or missing token.");
                return;
            }
            const owner = 'Zohocorp-Pvt-Ltd';
            const repo = 'Bigin-UI-Team';
            const branch = 'main';

            const files = [
                {
                    path: 'dist/icons-array.js',
                    content: `const iconsArray = ${JSON.stringify(iconsArray)}`
                },
                {
                    path: 'dist/ux-icons-holder.js',
                    content: updatedIconSVG
                }
            ];

            const headers = {
                Authorization: `Bearer ${token}`,
                Accept: 'application/vnd.github+json'
            };

            const api = async (url, options = {}) => {
                const res = await fetch(url, { headers, ...options });
                const json = await res.json();
                if (!res.ok) throw new Error(`${options.method || 'GET'} ${url} failed: ${JSON.stringify(json)}`);
                return json;
            };

            try {
                // 1. Get latest commit and base tree
                const refData = await api(`https://api.github.com/repos/${owner}/${repo}/git/ref/heads/${branch}`);
                const latestCommitSha = refData.object.sha;

                const commitData = await api(`https://api.github.com/repos/${owner}/${repo}/git/commits/${latestCommitSha}`);
                const baseTreeSha = commitData.tree.sha;

                // 2. Create blobs and build tree items
                const treeItems = await Promise.all(files.map(async ({ path, content }) => {
                    const blob = await api(`https://api.github.com/repos/${owner}/${repo}/git/blobs`, {
                        method: 'POST',
                        body: JSON.stringify({ content, encoding: 'utf-8' })
                    });
                    return { path, mode: '100644', type: 'blob', sha: blob.sha };
                }));

                // 3. Create new tree
                const tree = await api(`https://api.github.com/repos/${owner}/${repo}/git/trees`, {
                    method: 'POST',
                    body: JSON.stringify({ base_tree: baseTreeSha, tree: treeItems })
                });

                // 4. Create new commit
                const newCommit = await api(`https://api.github.com/repos/${owner}/${repo}/git/commits`, {
                    method: 'POST',
                    body: JSON.stringify({
                        message: commitMessage,
                        tree: tree.sha,
                        parents: [latestCommitSha]
                    })
                });

                // 5. Update ref
                await api(`https://api.github.com/repos/${owner}/${repo}/git/refs/heads/${branch}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ sha: newCommit.sha })
                });

                alert("‚úÖ All files updated in a single commit!");
            } catch (error) {
                console.error("‚ùå GitHub upload failed:", error.message);
                alert("‚ùå GitHub upload failed. Check console for details.");
            }
        }




    </script>
</body>

</html>